name: Daily Scrape
on:
  schedule:
    - cron: '50 22 * * *'  # 毎日 22:50 UTC = 日本時間 7:50
  workflow_dispatch:
jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright python-dotenv
          playwright install firefox
      
      - name: Run scrape test
        env:
          SALONBOARD_LOGIN_ID: ${{ secrets.SALONBOARD_LOGIN_ID }}
          SALONBOARD_LOGIN_PASSWORD: ${{ secrets.SALONBOARD_LOGIN_PASSWORD }}
        run: |
          python -c "
          from playwright.sync_api import sync_playwright
          import os
          import time

          print('=== GitHub Actions スクレイピングテスト (Firefox) ===')
          
          with sync_playwright() as p:
              browser = p.firefox.launch(
                  headless=True,
                  firefox_user_prefs={
                      'dom.webdriver.enabled': False,
                      'useAutomationExtension': False
                  }
              )
              context = browser.new_context(
                  viewport={'width': 1920, 'height': 1080},
                  user_agent='Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:109.0) Gecko/20100101 Firefox/115.0'
              )
              page = context.new_page()
              
              print('サロンボードにアクセス中...')
              page.goto('https://salonboard.com/login/', timeout=60000, wait_until='networkidle')
              print(f'ページタイトル: {page.title()}')
              
              # 少し待機
              page.wait_for_timeout(3000)
              
              # ページのHTMLを確認
              html = page.content()
              if 'login_id' in html:
                  print('✅ ログインフォームが見つかりました')
              else:
                  print('❌ ログインフォームが見つかりません')
                  print('HTML抜粋:', html[:500])
              
              # ログイン試行
              page.wait_for_selector('input[name=\"login_id\"]', timeout=10000)
              page.fill('input[name=\"login_id\"]', os.environ['SALONBOARD_LOGIN_ID'])
              page.fill('input[name=\"login_password\"]', os.environ['SALONBOARD_LOGIN_PASSWORD'])
              page.click('button[type=\"submit\"]')
              
              page.wait_for_timeout(5000)
              print(f'ログイン後URL: {page.url}')
              
              if 'top' in page.url or 'KLP' in page.url:
                  print('✅ ログイン成功！Bot検知されませんでした')
              else:
                  print('❌ ログイン失敗またはBot検知された可能性')
              
              browser.close()
          "
