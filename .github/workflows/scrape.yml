name: Daily Scrape
on:
  schedule:
    - cron: '50 22 * * *'  # 毎日 22:50 UTC = 日本時間 7:50
  workflow_dispatch:
jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install playwright python-dotenv playwright-stealth
          playwright install firefox
      
      - name: Run scrape test
        env:
          SALONBOARD_LOGIN_ID: ${{ secrets.SALONBOARD_LOGIN_ID }}
          SALONBOARD_LOGIN_PASSWORD: ${{ secrets.SALONBOARD_LOGIN_PASSWORD }}
        run: |
          python -c "
          from playwright.sync_api import sync_playwright
          from playwright_stealth import stealth_sync
          import os

          print('=== GitHub Actions スクレイピングテスト (Firefox + Stealth) ===')
          
          with sync_playwright() as p:
              browser = p.firefox.launch(headless=True)
              page = browser.new_page()
              stealth_sync(page)
              
              print('サロンボードにアクセス中...')
              page.goto('https://salonboard.com/login/', timeout=60000)
              print(f'ページタイトル: {page.title()}')
              
              # ログイン
              page.fill('input[name=\"login_id\"]', os.environ['SALONBOARD_LOGIN_ID'])
              page.fill('input[name=\"login_password\"]', os.environ['SALONBOARD_LOGIN_PASSWORD'])
              page.click('button[type=\"submit\"]')
              
              page.wait_for_timeout(5000)
              print(f'ログイン後URL: {page.url}')
              
              if 'top' in page.url or 'KLP' in page.url:
                  print('✅ ログイン成功！Bot検知されませんでした')
              else:
                  print('❌ ログイン失敗またはBot検知された可能性')
              
              browser.close()
          "
